<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smartphone Sensing Analyzer — Single File</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide icons CDN -->
  <script src="https://unpkg.com/lucide@0.286.0/dist/lucide.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #4f46e5;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      margin-top: -8px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-2xl">
    <header class="text-center mb-6">
      <div class="flex items-center justify-center space-x-3">
        <svg id="camera-icon" class="w-7 h-7 text-red-500"></svg>
        <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-700">Smartphone Sensing Analyzer</h1>
      </div>
      <p class="mt-2 text-gray-500">Extract RGB, analyze with AI (optional), and track experiments.</p>
    </header>

    <!-- Status / Errors -->
    <div id="status" class="mb-4"></div>

    <!-- Upload -->
    <div class="mb-6 p-4 bg-indigo-50 rounded-xl border border-indigo-200">
      <label for="file-upload" class="cursor-pointer flex flex-col items-center p-6 border-4 border-dashed border-indigo-400 rounded-xl hover:border-indigo-600">
        <svg id="upload-icon" class="w-8 h-8 text-indigo-500"></svg>
        <span id="file-label" class="mt-2 text-lg font-semibold text-indigo-700">Click to Upload Fluorescence Image</span>
        <span class="text-sm text-gray-500">PNG or JPEG (max ~5MB recommended)</span>
        <input id="file-upload" type="file" accept="image/*" class="hidden" />
      </label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Left: Image preview + RGB -->
      <div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Region of Interest (ROI) Size: <span id="roi-value">15</span> px</label>
          <input id="roi-range" type="range" min="5" max="40" step="1" value="15" class="w-full" />
        </div>

        <div id="preview-container" class="w-full aspect-[4/3] rounded-xl overflow-hidden shadow-lg border border-gray-300 bg-gray-200 flex items-center justify-center">
          <p id="preview-placeholder" class="text-gray-500 italic">Image Preview</p>
          <div id="image-wrapper" class="relative w-full h-full hidden cursor-pointer">
            <img id="preview-img" src="" alt="preview" class="w-full h-full object-cover pointer-events-none" />
            <div id="sample-indicator" class="absolute rounded-full border-4 border-white shadow-[0_0_0_2px_rgba(0,0,0,0.5)] pointer-events-none" title="Sample point"></div>
            <p class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs font-medium text-white bg-black bg-opacity-50 px-2 py-1 rounded-full">Click image to set sample point</p>
          </div>
        </div>

        <canvas id="hidden-canvas" width="100" height="100" style="display:none;"></canvas>

        <div class="flex justify-around mt-4">
          <div class="flex flex-col items-center p-3 rounded-lg bg-white border border-gray-200">
            <div id="r-chip" class="w-10 h-10 rounded-full mb-1 border-2 border-gray-300"></div>
            <span class="font-bold text-xl text-red-600">R</span>
            <span id="r-val" class="text-sm text-gray-700">0</span>
          </div>
          <div class="flex flex-col items-center p-3 rounded-lg bg-white border border-gray-200">
            <div id="g-chip" class="w-10 h-10 rounded-full mb-1 border-2 border-gray-300"></div>
            <span class="font-bold text-xl text-green-600">G</span>
            <span id="g-val" class="text-sm text-gray-700">0</span>
          </div>
          <div class="flex flex-col items-center p-3 rounded-lg bg-white border border-gray-200">
            <div id="b-chip" class="w-10 h-10 rounded-full mb-1 border-2 border-gray-300"></div>
            <span class="font-bold text-xl text-blue-600">B</span>
            <span id="b-val" class="text-sm text-gray-700">0</span>
          </div>
        </div>
      </div>

      <!-- Right: AI Prediction + Buttons -->
      <div>
        <button id="analyze-btn" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-semibold mb-4 disabled:opacity-60" disabled>
          Estimate Intensity
        </button>

        <div class="p-4 bg-white rounded-xl border border-gray-200 min-h-[170px]">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">Prediction Summary</h3>
          <div id="prediction-area" class="text-gray-600 italic">Upload an image and click "Estimate Intensity".</div>
        </div>

        <div id="protocol-block" class="mt-4 p-4 bg-yellow-50 rounded-xl border border-yellow-200 hidden">
          <h3 class="font-semibold mb-2">Standard Protocol Guidance</h3>
          <button id="gen-protocol-btn" class="w-full py-2 rounded-lg bg-yellow-500 text-white font-semibold mb-3">Generate Calibration Protocol</button>
          <pre id="protocol-text" class="text-sm bg-white p-3 rounded border border-gray-200 max-h-40 overflow-y-auto"></pre>
        </div>

        <div id="save-block" class="mt-4 hidden">
          <button id="save-btn" class="w-full py-2 rounded-lg bg-green-500 text-white font-semibold mb-2">Save Result to History</button>
        </div>
      </div>
    </div>

    <hr class="my-8" />

    <section>
      <h2 class="text-xl font-bold mb-4">Experimental History</h2>
      <div id="history" class="bg-gray-100 p-4 rounded-xl max-h-64 overflow-y-auto">
        <p class="text-gray-500 italic">No results saved yet.</p>
      </div>
    </section>

    <footer class="mt-6 text-sm text-gray-400 text-center">
      Application ID: external-sensing-app — Demo conversion by assistant
    </footer>
  </div>

<script>
/* ------------- CONFIG: Set your keys/config here ------------- */

/* Gemini API key (optional). If empty, AI calls will be disabled.
   Note: calling Google Generative Language API from a browser may cause CORS issues.
   Recommended: call from a server-side proxy or add proper CORS allow rules on the server.
*/
const GEMINI_API_KEY = ""; // set your API key here

/* Firebase optional config. If you want Firestore persistence, paste your config here.
   Example:
const FIREBASE_CONFIG = {
  apiKey: "...",
  authDomain: "...",
  projectId: "...",
  storageBucket: "...",
  messagingSenderId: "...",
  appId: "..."
};
*/
const FIREBASE_CONFIG = null; // set to an object to enable Firestore integration

/* ------------- End config ------------- */

/* Simple utility for status messages */
const statusEl = document.getElementById('status');
function setStatus(msg, type = 'info') {
  if (!msg) { statusEl.innerHTML = ''; return; }
  const color = (type==='error') ? 'red' : (type==='success') ? 'green' : 'yellow';
  statusEl.innerHTML = '<div class="p-3 rounded-lg text-sm ' +
    (type==='error' ? 'bg-red-100 border border-red-400 text-red-700' : (type==='success' ? 'bg-green-100 border border-green-400 text-green-700' : 'bg-yellow-100 border border-yellow-400 text-yellow-700')) +
    '">' + msg + '</div>';
}

/* DOM refs */
const fileInput = document.getElementById('file-upload');
const fileLabel = document.getElementById('file-label');
const previewPlaceholder = document.getElementById('preview-placeholder');
const imageWrapper = document.getElementById('image-wrapper');
const previewImg = document.getElementById('preview-img');
const sampleIndicator = document.getElementById('sample-indicator');
const previewContainer = document.getElementById('preview-container');
const roiRange = document.getElementById('roi-range');
const roiValue = document.getElementById('roi-value');
const rVal = document.getElementById('r-val');
const gVal = document.getElementById('g-val');
const bVal = document.getElementById('b-val');
const rChip = document.getElementById('r-chip');
const gChip = document.getElementById('g-chip');
const bChip = document.getElementById('b-chip');
const analyzeBtn = document.getElementById('analyze-btn');
const predictionArea = document.getElementById('prediction-area');
const protocolBlock = document.getElementById('protocol-block');
const genProtocolBtn = document.getElementById('gen-protocol-btn');
const protocolText = document.getElementById('protocol-text');
const saveBlock = document.getElementById('save-block');
const saveBtn = document.getElementById('save-btn');
const historyEl = document.getElementById('history');
const hiddenCanvas = document.getElementById('hidden-canvas');

let currentFile = null;
let previewUrl = '';
let base64Image = '';
let rgb = { r:0, g:0, b:0 };
let samplePos = { x: 50, y: 50 }; // percent
let roiSize = parseInt(roiRange.value, 10) || 15;
let aiResult = null;

/* Helper: file -> base64 */
function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/* Extract average RGB from a region on a 100x100 canvas */
function extractRGBFromImage(img, pos, size) {
  const canvas = hiddenCanvas;
  const ctx = canvas.getContext('2d');
  const width = 100, height = 100;
  canvas.width = width;
  canvas.height = height;
  // draw image to fit 100x100
  ctx.clearRect(0,0,width,height);
  ctx.drawImage(img, 0, 0, width, height);

  const sampleSize = size;
  let startX = Math.round((pos.x / 100) * width) - Math.floor(sampleSize / 2);
  let startY = Math.round((pos.y / 100) * height) - Math.floor(sampleSize / 2);
  startX = Math.max(0, Math.min(width - sampleSize, startX));
  startY = Math.max(0, Math.min(height - sampleSize, startY));

  const imageData = ctx.getImageData(startX, startY, sampleSize, sampleSize);
  const data = imageData.data;
  let totalR = 0, totalG = 0, totalB = 0;
  const pixelCount = data.length / 4;
  for (let i=0;i<data.length;i+=4){
    totalR += data[i];
    totalG += data[i+1];
    totalB += data[i+2];
  }
  rgb.r = Math.round(totalR / pixelCount);
  rgb.g = Math.round(totalG / pixelCount);
  rgb.b = Math.round(totalB / pixelCount);
  updateRGBUI();
}

/* Update the small RGB chips */
function updateRGBUI(){
  rVal.textContent = rgb.r;
  gVal.textContent = rgb.g;
  bVal.textContent = rgb.b;
  rChip.style.backgroundColor = `rgb(${rgb.r},0,0)`;
  gChip.style.backgroundColor = `rgb(0,${rgb.g},0)`;
  bChip.style.backgroundColor = `rgb(0,0,${rgb.b})`;
}

/* Handle file chosen */
fileInput.addEventListener('change', async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  if (!f.type.startsWith('image/')) {
    setStatus('Please choose an image file.', 'error');
    return;
  }
  setStatus('', null);
  currentFile = f;
  fileLabel.textContent = f.name;
  const dataUrl = await fileToDataURL(f);
  previewUrl = dataUrl;
  base64Image = dataUrl.split(',')[1];
  previewImg.src = dataUrl;
  previewPlaceholder.style.display = 'none';
  imageWrapper.classList.remove('hidden');
  previewImg.onload = () => {
    // default center
    samplePos = { x:50, y:50 };
    updateSampleIndicator();
    extractRGBFromImage(previewImg, samplePos, roiSize);
    analyzeBtn.disabled = false;
    predictionArea.innerHTML = '<p class="text-center text-gray-400 italic">Ready — click "Estimate Intensity".</p>';
  };
});

/* Click to set sample point */
document.getElementById('image-wrapper').addEventListener('click', (e) => {
  const rect = e.currentTarget.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  const normalizedX = (x / rect.width) * 100;
  const normalizedY = (y / rect.height) * 100;
  samplePos = { x: normalizedX, y: normalizedY };
  updateSampleIndicator();
  if (previewImg.src) {
    extractRGBFromImage(previewImg, samplePos, roiSize);
    aiResult = null;
    predictionArea.innerHTML = '<p class="text-gray-400 italic text-center">Point changed — click "Estimate Intensity".</p>';
  }
});

/* Update visual sample indicator */
function updateSampleIndicator(){
  const el = sampleIndicator;
  const sizePercent = Math.max(3, (roiSize * 0.4)); // visual scaling
  el.style.left = samplePos.x + '%';
  el.style.top = samplePos.y + '%';
  el.style.transform = 'translate(-50%, -50%)';
  el.style.width = sizePercent + '%';
  el.style.height = sizePercent + '%';
}

/* ROI range */
roiRange.addEventListener('input', (e) => {
  roiSize = parseInt(e.target.value,10);
  roiValue.textContent = roiSize;
  if (previewImg.src) extractRGBFromImage(previewImg, samplePos, roiSize);
});

/* Retry-enabled fetch */
async function fetchWithRetry(url, options={}, retries=3){
  for (let i=0;i<retries;i++){
    try {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res;
    } catch (err) {
      if (i === retries-1) throw err;
      await new Promise(r => setTimeout(r, Math.pow(2,i)*500 + Math.random()*300));
    }
  }
}

/* Build Gemini payload (mirrors original) */
function buildGeminiPayload() {
  const prompt = `You are a highly sensitive and quantitative Spectrophotometric Analysis Engine specializing in image-based chemical sensing. Your task is to estimate the Relative Fluorescence Intensity (RFI) of the chemical sample shown in the image, providing a high-confidence score between 0 and 100.

INPUT DATA:
1. Image (provided separately)
2. Sample Point (Normalized): (${samplePos.x.toFixed(1)}%, ${samplePos.y.toFixed(1)}%)
3. ROI Size (Pixels): ${roiSize}x${roiSize}
4. Measured Average RGB (0-255): Red: ${rgb.r}, Green: ${rgb.g}, Blue: ${rgb.b}

ANALYSIS CRITERIA:
Use the magnitude of the RGB values and brightness as primary inputs. Provide a JSON object with keys intensity_score (0-100), color_description, analysis_notes.`;

  const systemPrompt = "Output a single JSON object only.";

  const payload = {
    contents: [
      {
        role: "user",
        parts: [
          { text: prompt },
          {
            inlineData: {
              mimeType: "image/jpeg",
              data: base64Image
            }
          }
        ]
      }
    ],
    systemInstruction: {
      parts: [{ text: systemPrompt }]
    },
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: {
        type: "OBJECT",
        properties: {
          intensity_score: { type: "INTEGER" },
          color_description: { type: "STRING" },
          analysis_notes: { type: "STRING" }
        },
        required: ["intensity_score", "color_description", "analysis_notes"]
      }
    }
  };
  return payload;
}

/* Call Gemini API — may require server-side proxy due to CORS */
analyzeBtn.addEventListener('click', async () => {
  if (!base64Image) { setStatus('Upload an image first.', 'error'); return; }
  if (!GEMINI_API_KEY) {
    setStatus('GEMINI_API_KEY is empty — AI calls disabled. Client-side RGB still works.', 'info');
    // We can optionally produce a naive local estimation using brightness
    const brightness = (rgb.r + rgb.g + rgb.b) / 3;
    const estimated = Math.round((brightness/255) * 100);
    aiResult = {
      intensity_score: estimated,
      color_description: (rgb.g > rgb.r && rgb.g > rgb.b) ? 'greenish' : (rgb.r > rgb.g && rgb.r > rgb.b) ? 'reddish' : (rgb.b > rgb.r && rgb.b > rgb.g) ? 'blueish' : 'neutral',
      analysis_notes: `Local estimate: brightness=${Math.round(brightness)} mapped to intensity ${estimated}/100.`
    };
    displayAiResult();
    return;
  }

  setStatus('Analyzing with Gemini...', 'info');
  analyzeBtn.disabled = true;
  predictionArea.innerHTML = '<p class="text-gray-500 italic">Contacting AI model — this may take a few seconds.</p>';

  try {
    const payload = buildGeminiPayload();
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
    const res = await fetchWithRetry(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }, 3);

    const result = await res.json();
    const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!jsonText) throw new Error('No JSON text in model response');
    const parsed = JSON.parse(jsonText);
    aiResult = parsed;
    displayAiResult();
    setStatus('AI analysis complete.', 'success');
  } catch (err) {
    console.error('AI error', err);
    setStatus('AI call failed. See console. You may need a server proxy or valid API key.', 'error');
    // fallback local estimate
    const brightness = (rgb.r + rgb.g + rgb.b) / 3;
    const estimated = Math.round((brightness/255) * 100);
    aiResult = {
      intensity_score: estimated,
      color_description: (rgb.g > rgb.r && rgb.g > rgb.b) ? 'greenish' : (rgb.r > rgb.g && rgb.r > rgb.b) ? 'reddish' : (rgb.b > rgb.r && rgb.b > rgb.g) ? 'blueish' : 'neutral',
      analysis_notes: `Fallback local estimate: brightness=${Math.round(brightness)} -> intensity ${estimated}/100.`
    };
    displayAiResult();
  } finally {
    analyzeBtn.disabled = false;
  }
});

function displayAiResult(){
  if (!aiResult) return;
  predictionArea.innerHTML = `
    <div class="p-3 bg-teal-50 rounded-lg border-l-4 border-teal-500">
      <p class="text-lg font-bold text-teal-700">Intensity Score: <span class="text-3xl">${aiResult.intensity_score} / 100</span></p>
      <p class="text-sm text-gray-600 mt-1">Color: ${aiResult.color_description}</p>
    </div>
    <p class="mt-3 text-gray-700"><strong>Analysis:</strong> ${aiResult.analysis_notes}</p>
  `;
  protocolBlock.classList.remove('hidden');
  saveBlock.classList.remove('hidden');
}

/* Protocol generation (uses Gemini similarly) */
genProtocolBtn.addEventListener('click', async () => {
  if (!aiResult) { setStatus('Run AI prediction first.', 'error'); return; }
  protocolText.textContent = 'Generating...';
  genProtocolBtn.disabled = true;
  try {
    if (!GEMINI_API_KEY) {
      protocolText.textContent = `1. Prepare simple calibration standard using common lab glassware.\n2. Dilute stock to desired concentration.\n3. Measure under consistent illumination. (Local fallback)`;
      return;
    }
    const protocolPrompt = `Generate a very brief, three-step standard operating procedure (SOP) for preparing a basic stock solution or calibration standards for a fluorescence sensing experiment for material that fluoresces ${aiResult.color_description} with intensity ${aiResult.intensity_score}/100.`;
    const payload = {
      contents: [{ parts: [{ text: protocolPrompt }] }],
      systemInstruction: { parts: [{ text: "Provide only 3 numbered steps." }] }
    };
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
    const res = await fetchWithRetry(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    }, 3);
    const result = await res.json();
    const protocolTextResp = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No protocol generated.';
    protocolText.textContent = protocolTextResp;
  } catch (err) {
    console.error('Protocol error', err);
    protocolText.textContent = 'Failed to generate protocol (see console).';
  } finally {
    genProtocolBtn.disabled = false;
  }
});

/* --- Simple local history (in-memory). If Firebase config provided, you can extend this to Firestore. --- */
let localHistory = [];
saveBtn.addEventListener('click', () => {
  if (!aiResult || !previewUrl) { setStatus('No result to save.', 'error'); return; }
  const entry = {
    id: Date.now().toString(),
    timestamp: new Date(),
    roiSize,
    samplePos,
    rgb: {...rgb},
    intensity: aiResult.intensity_score,
    color: aiResult.color_description,
    notes: aiResult.analysis_notes,
    previewUrl
  };
  localHistory.unshift(entry);
  renderHistory();
  setStatus('Result saved locally in browser memory (not persistent).', 'success');
});

/* Render history */
function renderHistory(){
  if (!localHistory.length) {
    historyEl.innerHTML = '<p class="text-gray-500 italic">No results saved yet.</p>';
    return;
  }
  historyEl.innerHTML = '';
  localHistory.forEach(item => {
    const div = document.createElement('div');
    div.className = 'p-3 mb-3 bg-white rounded-xl shadow-sm border border-gray-100 flex items-center justify-between';
    div.innerHTML = `
      <div class="flex-1 min-w-0">
        <div class="flex items-center space-x-2 text-sm font-semibold text-gray-800">
          <svg class="w-4 h-4 text-indigo-500"></svg>
          <span>${item.timestamp.toLocaleString()}</span>
        </div>
        <div class="mt-1 text-xs text-gray-600 truncate">
          Intensity: <span class="font-bold text-lg text-teal-600">${item.intensity}</span> | Color: ${item.color} | ROI: ${item.roiSize}x${item.roiSize}
        </div>
      </div>
      <button data-id="${item.id}" class="ml-4 p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-50">Delete</button>
    `;
    const btn = div.querySelector('button');
    btn.addEventListener('click', () => {
      localHistory = localHistory.filter(i => i.id !== item.id);
      renderHistory();
      setStatus('Result removed from local history.', 'success');
    });
    historyEl.appendChild(div);
  });
}

/* Bring small icons into placeholders (using lucide) */
document.addEventListener("DOMContentLoaded", function(){
  // replace skeleton icons with lucide
  const icons = {
    'camera-icon': 'camera',
    'upload-icon': 'upload'
  };
  Object.keys(icons).forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.outerHTML = lucide.createIcon(icons[id], { class: el.className });
    }
  });
});

/* Initial UI states */
roiValue.textContent = roiSize;
updateRGBUI();
setStatus(GEMINI_API_KEY ? 'Gemini API key present — AI enabled (may require server proxy).' : 'No Gemini API key provided — AI calls disabled (local estimate only).', 'info');

</script>
</body>
</html>
