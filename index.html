<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smartphone Sensing Analyzer — Secure Gemini Proxy</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@0.286.0/dist/lucide.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px; height: 20px; border-radius: 50%;
      background: #4f46e5; cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      margin-top: -8px;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-2xl">
    <header class="text-center mb-6">
      <div class="flex items-center justify-center space-x-3">
        <svg id="camera-icon" class="w-7 h-7 text-red-500"></svg>
        <h1 class="text-2xl sm:text-3xl font-extrabold text-indigo-700">Smartphone Sensing Analyzer</h1>
      </div>
      <p class="mt-2 text-gray-500">Extract RGB, analyze with AI (optional), and track experiments.</p>
    </header>

    <div id="status" class="mb-4"></div>

    <div class="mb-6 p-4 bg-indigo-50 rounded-xl border border-indigo-200">
      <label for="file-upload" class="cursor-pointer flex flex-col items-center p-6 border-4 border-dashed border-indigo-400 rounded-xl hover:border-indigo-600">
        <svg id="upload-icon" class="w-8 h-8 text-indigo-500"></svg>
        <span id="file-label" class="mt-2 text-lg font-semibold text-indigo-700">Click to Upload Fluorescence Image</span>
        <input id="file-upload" type="file" accept="image/*" class="hidden" />
      </label>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <div>
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Region of Interest (ROI) Size: <span id="roi-value">15</span> px</label>
          <input id="roi-range" type="range" min="5" max="40" step="1" value="15" class="w-full" />
        </div>

        <div id="preview-container" class="w-full aspect-[4/3] rounded-xl overflow-hidden shadow-lg border border-gray-300 bg-gray-200 flex items-center justify-center">
          <p id="preview-placeholder" class="text-gray-500 italic">Image Preview</p>
          <div id="image-wrapper" class="relative w-full h-full hidden cursor-pointer">
            <img id="preview-img" src="" alt="preview" class="w-full h-full object-cover pointer-events-none" />
            <div id="sample-indicator" class="absolute rounded-full border-4 border-white shadow-[0_0_0_2px_rgba(0,0,0,0.5)] pointer-events-none"></div>
            <p class="absolute bottom-2 left-1/2 -translate-x-1/2 text-xs font-medium text-white bg-black bg-opacity-50 px-2 py-1 rounded-full">Click to set sample point</p>
          </div>
        </div>

        <canvas id="hidden-canvas" width="100" height="100" style="display:none;"></canvas>

        <div class="flex justify-around mt-4">
          <div><div id="r-chip" class="w-10 h-10 rounded-full mb-1 border-2 border-gray-300"></div><span class="text-red-600 font-bold">R</span> <span id="r-val">0</span></div>
          <div><div id="g-chip" class="w-10 h-10 rounded-full mb-1 border-2 border-gray-300"></div><span class="text-green-600 font-bold">G</span> <span id="g-val">0</span></div>
          <div><div id="b-chip" class="w-10 h-10 rounded-full mb-1 border-2 border-gray-300"></div><span class="text-blue-600 font-bold">B</span> <span id="b-val">0</span></div>
        </div>
      </div>

      <div>
        <button id="analyze-btn" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-semibold mb-4 disabled:opacity-60" disabled>Estimate Intensity</button>
        <div class="p-4 bg-white rounded-xl border border-gray-200 min-h-[170px]">
          <h3 class="text-xl font-semibold text-gray-700 mb-3">Prediction Summary</h3>
          <div id="prediction-area" class="text-gray-600 italic">Upload an image and click "Estimate Intensity".</div>
        </div>
      </div>
    </div>

    <footer class="mt-6 text-sm text-gray-400 text-center">
      Secure Gemini Proxy Active — Vercel Deployment
    </footer>
  </div>

<script>
const statusEl = document.getElementById("status");
function setStatus(msg, type = "info") {
  const color = type === "error" ? "red" : type === "success" ? "green" : "yellow";
  statusEl.innerHTML = msg
    ? `<div class="p-3 rounded-lg text-sm bg-${color}-100 border border-${color}-400 text-${color}-700">${msg}</div>`
    : "";
}

const fileInput = document.getElementById("file-upload");
const previewImg = document.getElementById("preview-img");
const previewPlaceholder = document.getElementById("preview-placeholder");
const imageWrapper = document.getElementById("image-wrapper");
const hiddenCanvas = document.getElementById("hidden-canvas");
const analyzeBtn = document.getElementById("analyze-btn");
const predictionArea = document.getElementById("prediction-area");
const rVal = document.getElementById("r-val"), gVal = document.getElementById("g-val"), bVal = document.getElementById("b-val");
const rChip = document.getElementById("r-chip"), gChip = document.getElementById("g-chip"), bChip = document.getElementById("b-chip");

let base64Image = "", rgb = { r:0,g:0,b:0 }, samplePos = { x:50, y:50 }, roiSize = 15;

fileInput.addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = () => {
    base64Image = reader.result.split(",")[1];
    previewImg.src = reader.result;
    previewPlaceholder.style.display = "none";
    imageWrapper.classList.remove("hidden");
    extractRGB(previewImg);
    analyzeBtn.disabled = false;
  };
  reader.readAsDataURL(file);
});

function extractRGB(img){
  const ctx = hiddenCanvas.getContext("2d");
  ctx.drawImage(img, 0, 0, 100, 100);
  const data = ctx.getImageData(0, 0, 100, 100).data;
  let R=0,G=0,B=0;
  for(let i=0;i<data.length;i+=4){R+=data[i];G+=data[i+1];B+=data[i+2];}
  const count=data.length/4;
  rgb = { r:Math.round(R/count), g:Math.round(G/count), b:Math.round(B/count)};
  rVal.textContent=rgb.r; gVal.textContent=rgb.g; bVal.textContent=rgb.b;
  rChip.style.backgroundColor=`rgb(${rgb.r},0,0)`;
  gChip.style.backgroundColor=`rgb(0,${rgb.g},0)`;
  bChip.style.backgroundColor=`rgb(0,0,${rgb.b})`;
}

// ✅ Use your Vercel API proxy route (no key exposed)
const GEMINI_API_URL = "/api/gemini";

async function callGeminiAPI(prompt, imageBase64) {
  try {
    const res = await fetch(GEMINI_API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ prompt, image: imageBase64 }),
    });
    const data = await res.json();
    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || "No response.";
    return text;
  } catch (err) {
    console.error("Gemini fetch error", err);
    return "Error connecting to Gemini API.";
  }
}

analyzeBtn.addEventListener("click", async () => {
  setStatus("Analyzing with Gemini...", "info");
  const prompt = `Analyze fluorescence intensity for this RGB:
R:${rgb.r}, G:${rgb.g}, B:${rgb.b}. Provide JSON with keys: intensity_score, color_description, analysis_notes.`;
  const resultText = await callGeminiAPI(prompt, base64Image);
  predictionArea.innerHTML = `<pre class="bg-gray-50 p-3 rounded">${resultText}</pre>`;
  setStatus("AI analysis complete!", "success");
});

setStatus("Gemini API key is set in Vercel → Environment Variables", "info");
</script>
</body>
</html>
